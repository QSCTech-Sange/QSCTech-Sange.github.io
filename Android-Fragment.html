<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Android 组件 Fragment 的使用 | 三个技术小站</title><meta name="description" content="Fragment 是绝大多数APP的必备组件，可以理解为打碎的Activity，重要程度不亚于四大组件。"><meta name="keywords" content="Android"><meta name="author" content="杨宇昊"><meta name="copyright" content="杨宇昊"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/red_shark.webp"><link rel="canonical" href="https://qsctech-sange.github.io/Android-Fragment.html"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin="crossorigin"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="ykFGsmFH8M0zGBTxnp6wJbCxJCcrr-5_xEd74sfqA6s"/><meta name="msvalidate.01" content="B9612ADF0D9A92F7A76CC3705B2645F6"/><meta name="360-site-verification" content="4417b2a102039ff12038fca1701a3618"/><meta name="yandex-verification" content="{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}"/><meta property="og:type" content="article"><meta property="og:title" content="Android 组件 Fragment 的使用"><meta property="og:url" content="https://qsctech-sange.github.io/Android-Fragment.html"><meta property="og:site_name" content="三个技术小站"><meta property="og:description" content="Fragment 是绝大多数APP的必备组件，可以理解为打碎的Activity，重要程度不亚于四大组件。"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/Android-Fragment-cover.webp"><meta property="article:published_time" content="2019-01-01T06:51:36.000Z"><meta property="article:modified_time" content="2019-09-16T06:11:48.770Z"><meta name="twitter:card" content="summary"><link rel="manifest" href="/image/pwa/manifest.json"/><meta name="theme-color" content="#fff"/><meta name="msapplication-TileColor" content="#fff"/><link rel="apple-touch-icon" sizes="180x180" href="/image/pwa/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/image/pwa/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/image/pwa/16.png"/><link rel="mask-icon" href="/image/pwa/safari-pinned-tab.svg" color="#5bbad5"/><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-1684591464347392',
  enable_page_level_ads: 'true'
});</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?bbe3106fee7fc090c2fbe9fa14e2ea91";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=156936411-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '156936411-1');
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.0.2',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"距离上次更新已经过去了","messageNext":"天，文章内容可能已经过时。"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"limitCount":50,"languages":{"author":"作者: 杨宇昊","link":"链接: ","source":"来源: 三个技术小站","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: true    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2019-09-16 14:11:48'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/red_shark.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">241</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">67</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#p-aligncenter%E8%BF%8E%E6%96%B0%E5%B9%B4high-%E7%BF%BB%E5%A4%A9p"><span class="toc-number">1.</span> <span class="toc-text"> 迎新年，High 翻天</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#android-%E7%BB%84%E5%86%85%E8%AE%AD-fragment-%E7%89%B9%E5%88%AB%E7%AF%87%E5%90%AB%E6%83%8A%E5%96%9C"><span class="toc-number">2.</span> <span class="toc-text"> Android 组内训—— Fragment 特别篇（含惊喜）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-fragment"><span class="toc-number">2.1.</span> <span class="toc-text"> 什么是 Fragment ？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#activity"><span class="toc-number">2.1.1.</span> <span class="toc-text"> Activity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service"><span class="toc-number">2.1.2.</span> <span class="toc-text"> Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#content-provider"><span class="toc-number">2.1.3.</span> <span class="toc-text"> Content Provider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#broadcast-receiver"><span class="toc-number">2.1.4.</span> <span class="toc-text"> Broadcast Receiver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E7%A2%8E-activity"><span class="toc-number">2.1.5.</span> <span class="toc-text"> 打碎 Activity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fragment-%E5%92%8C-activity-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.1.6.</span> <span class="toc-text"> Fragment 和 Activity 的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fragment-%E5%92%8C-activity-%E7%9A%84%E4%B8%A4%E8%80%85%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.1.6.1.</span> <span class="toc-text"> Fragment 和 Activity 的两者的生命周期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragment-%E4%BC%98%E5%8A%BF"><span class="toc-number">2.2.</span> <span class="toc-text"> Fragment 优势</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fragement-%E6%A0%B8%E5%BF%83%E7%B1%BB"><span class="toc-number">2.2.1.</span> <span class="toc-text"> Fragement 核心类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.</span> <span class="toc-text"> 使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%8A-fragment-%E5%BD%93%E4%BD%9C%E6%8E%A7%E4%BB%B6%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 把 Fragment 当作控件使用（静态使用）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#afragmentjava"><span class="toc-number">2.3.1.1.</span> <span class="toc-text"> AFragment.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#afragmentxml"><span class="toc-number">2.3.1.2.</span> <span class="toc-text"> afragment.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#activity_mainxml"><span class="toc-number">2.3.1.3.</span> <span class="toc-text"> activity_main.xml</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#layoutinflater%E5%B8%83%E5%B1%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text"> layoutInflater(布局服务)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#viewgroup"><span class="toc-number">2.5.</span> <span class="toc-text"> ViewGroup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bundle"><span class="toc-number">2.6.</span> <span class="toc-text"> Bundle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD-fragment"><span class="toc-number">2.6.1.</span> <span class="toc-text"> 动态加载 Fragment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mainactivityjava"><span class="toc-number">2.6.1.1.</span> <span class="toc-text"> MainActivity.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#activity_mainxml-2"><span class="toc-number">2.6.1.2.</span> <span class="toc-text"> activity_main.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1addint-containerviewid-fragment-fragment"><span class="toc-number">2.6.1.3.</span> <span class="toc-text"> 1)add(int containerViewId, Fragment fragment)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2hidefragment-fragment%E5%92%8Cshowfragment-fragment"><span class="toc-number">2.6.1.4.</span> <span class="toc-text"> 2)hide(Fragment fragment)和show(Fragment fragment)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3removefragment-fragment"><span class="toc-number">2.6.1.5.</span> <span class="toc-text"> 3)remove(Fragment fragment)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4replaceint-containerviewid-fragment-fragment"><span class="toc-number">2.6.1.6.</span> <span class="toc-text"> 4)replace(int containerViewId, Fragment fragment)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5detach"><span class="toc-number">2.6.1.7.</span> <span class="toc-text"> 5)detach()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6attach"><span class="toc-number">2.6.1.8.</span> <span class="toc-text"> 6)attach()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragment-%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%9C%89%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">2.7.</span> <span class="toc-text"> Fragment 与生命周期有关方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1onattach"><span class="toc-number">2.7.1.</span> <span class="toc-text"> 1).onAttach</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2oncreate"><span class="toc-number">2.7.2.</span> <span class="toc-text"> 2).onCreate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3oncreateview"><span class="toc-number">2.7.3.</span> <span class="toc-text"> 3).onCreateView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4onactivitycreated"><span class="toc-number">2.7.4.</span> <span class="toc-text"> 4).onActivityCreated</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5ondestoryview"><span class="toc-number">2.7.5.</span> <span class="toc-text"> 5)onDestoryView()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6ondestroy%E6%96%B9%E6%B3%95"><span class="toc-number">2.7.6.</span> <span class="toc-text"> 6)onDestroy()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7ondetach"><span class="toc-number">2.7.7.</span> <span class="toc-text"> 7)onDetach()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragment-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%92%8C-back-stack"><span class="toc-number">2.8.</span> <span class="toc-text"> Fragment 实现原理和 Back Stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragment%E9%80%9A%E4%BF%A1"><span class="toc-number">2.9.</span> <span class="toc-text"> Fragment通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fragment%E5%90%91activity%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">2.9.1.</span> <span class="toc-text"> Fragment向Activity传递数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fabridge"><span class="toc-number">2.9.2.</span> <span class="toc-text"> FABridge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#activity-%E5%90%91-fragment-%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE"><span class="toc-number">2.9.3.</span> <span class="toc-text"> Activity 向 Fragment 传递数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fragment-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">2.9.4.</span> <span class="toc-text"> Fragment 之间通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dialogfragment"><span class="toc-number">2.9.5.</span> <span class="toc-text"> DialogFragment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragment%E7%9A%84%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.10.</span> <span class="toc-text"> Fragment的典型应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#viewpagerfragment%E7%BB%93%E6%9E%84"><span class="toc-number">2.10.1.</span> <span class="toc-text"> ViewPager+Fragment结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%8F%E9%AA%8C"><span class="toc-number">2.10.1.1.</span> <span class="toc-text"> 经验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.10.2.</span> <span class="toc-text"> 懒加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">2.11.</span> <span class="toc-text"> 参考文献</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/Androidtop.webp)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">三个技术小站</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Android 组件 Fragment 的使用</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-01-01T06:51:36.000Z" title="发表于 2019-01-01 14:51:36">2019-01-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-09-16T06:11:48.770Z" title="更新于 2019-09-16 14:11:48">2019-09-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/Android-Fragment#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/Android-Fragment" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="p-aligncenter迎新年high-翻天p"><a class="markdownIt-Anchor" href="#p-aligncenter迎新年high-翻天p"></a> <p align="center">迎新年，High 翻天</p></h1>
<h1 id="android-组内训-fragment-特别篇含惊喜"><a class="markdownIt-Anchor" href="#android-组内训-fragment-特别篇含惊喜"></a> Android 组内训—— Fragment 特别篇（含惊喜）</h1>
<p>QSC TECH最崇拜钥匙的，同时也是最弟弟的成员：<code>三个</code> <code>杨宇昊</code></p>
<blockquote>
<p><code>Google</code> 对于 <code>Fragment</code> 的<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/fragment/app/Fragment">官方文档</a></p>
<p>贵潮 <code>Gitlab</code> 上的 <code>FragmentDemo</code> <a href="%22https://git.zjuqsc.com/3160105521/FragmentDemo%22">项目</a></p>
</blockquote>
<h2 id="什么是-fragment"><a class="markdownIt-Anchor" href="#什么是-fragment"></a> 什么是 Fragment ？</h2>
<p><code>Fragment</code>，简称碎片。自从谷歌在 Android3.0（还记得吗？为了平板而推出的3.0）推出 Fragment 以后，Fragment 就成为了绝大多数 APP 的必备元素，其重要程度一点也不亚于四大组件。</p>
<blockquote>
<p>复习：四大组件——</p>
<ol>
<li>Activity</li>
<li>Service</li>
<li>Content Provider</li>
<li>Broadcast Receiver</li>
</ol>
<p><strong>提问环节</strong>：我将抽一个小朋友提问关于这四大组件的问题，作为新年礼物。会是谁这么幸运呢？</p>
<p><strong>参考答案</strong></p>
<h3 id="activity"><a class="markdownIt-Anchor" href="#activity"></a> Activity</h3>
<p><code>Activity</code> 是一个应用组件，用户可与其提供的屏幕进行交互，以执行拨打电话、拍摄照片、发送电子邮件或查看地图等操作。 每个 Activity 都会获得一个用于绘制其用户界面的窗口。窗口通常会充满屏幕，但也可小于屏幕并浮动在其他窗口之上。</p>
<p>一个应用通常由多个彼此松散联系的 Activity 组成。 一般会指定应用中的某个 Activity 为“主”Activity，即首次启动应用时呈现给用户的那个 Activity。 而且每个 Activity 均可启动另一个 Activity，以便执行不同的操作。 每次新 Activity 启动时，前一 Activity 便会停止，但系统会在堆栈（“返回栈”）中保留该 Activity。 当新 Activity 启动时，系统会将其推送到返回栈上，并取得用户焦点。 返回栈遵循基本的“后进先出”堆栈机制，因此，当用户完成当前 Activity 并按“返回”按钮时，系统会从堆栈中将其弹出（并销毁），然后恢复前一 Activity。</p>
<p>当一个 Activity 因某个新 Activity 启动而停止时，系统会通过该 Activity 的生命周期回调方法通知其这一状态变化。Activity 因状态变化—系统是创建 Activity、停止 Activity、恢复 Activity 还是销毁 Activity— 而收到的回调方法可能有若干种，每一种回调都会为您提供执行与该状态变化相应的特定操作的机会。 例如，停止时，您的 Activity 应释放任何大型对象，例如网络或数据库连接。 当 Activity 恢复时，您可以重新获取所需资源，并恢复执行中断的操作。 这些状态转变都是 Activity 生命周期的一部分。</p>
<h3 id="service"><a class="markdownIt-Anchor" href="#service"></a> Service</h3>
<p><code>Service</code>表示一个应用期望去执行一个不与用户交互的较长的操作或者通过一些功能为其他应用去使用。Service是Android提供一个允许长时间留驻后台的一个组件，最常见的用法就是做轮询操作或者想在后台做一些事情，比如后台下载更新。Service通常总是称之为“后台服务”，其中“后台”一词是相对于前台而言的，具体是指其本身的运行并不依赖于用户可视的UI界面，因此，从实际业务需求上来理解，Service的适用场景应该具备以下条件：</p>
<ol>
<li>并不依赖于用户可视的UI界面（当然，这一条其实也不是绝对的，如前台Service就是与Notification界面结合使用的）；</li>
<li>具有较长时间的运行特性。</li>
</ol>
<h3 id="content-provider"><a class="markdownIt-Anchor" href="#content-provider"></a> Content Provider</h3>
<p><code>ContentProvider</code>是不同应用程序之间进行数据交换的标准API。ContentProvider可以理解为一个Android应用对外开放的接口，只要是符合它所定义的Uri格式的请求，均可以正常访问执行操作。其他的Android应用可以使用ContentResolver对象通过与ContentProvider同名的方法请求执行，被执行的就是ContentProvider中的同名方法。</p>
<h3 id="broadcast-receiver"><a class="markdownIt-Anchor" href="#broadcast-receiver"></a> Broadcast Receiver</h3>
<p>在Android中，<code>Broadcast</code>是一种广泛运用的在应用程序之间传输信息的机制。而BroadcastReceiver是对发送出来的 Broadcast进行过滤接受并响应的一类组件。</p>
<p>下面将详细的阐述如何发送Broadcast和使用BroadcastReceiver过滤接收的过程：</p>
<p>首先在需要发送信息的地方，把要发送的信息和用于过滤的信息(如Action、Category)装入一个Intent对象，然后通过调用 sendOrderBroadcast()或sendStickyBroadcast()方法，把 Intent对象以广播方式发送出去。</p>
<p>当Intent发送以后，所有已经注册的BroadcastReceiver会检查注册时的IntentFilter是否与发送的Intent相匹配，若匹配则就会调用BroadcastReceiver的onReceive()方法。所以当我们定义一个BroadcastReceiver的时候，都需要实现onReceive()方法。</p>
</blockquote>
<h3 id="打碎-activity"><a class="markdownIt-Anchor" href="#打碎-activity"></a> 打碎 Activity</h3>
<p>从字面上来看，Fragment 的意思是碎片，谷歌的本意在于将一个 Activity 的界面进行碎片化，好让开发者根据不同的屏幕来进行不同的 Fragment 组合以来达到动态布局的效果。</p>
<p>但从目前的情况来看，因为 Android 平板电脑的市场占有率偏低，多数应用都未对平板进行单独适配，即使有适配的 APP 也是单独维护一个平板的项目与手机项目剥离开来进行UI的编写与适配。但是这并没有影响到广大开发者对 Fragment 的喜爱，因为 fragment 作为一个 UI 界面的载体，它的使用上十分灵活。</p>
<p>同时更重要的一点是，同样实现一个界面，Fragment 相对于 Activity 来说更加省内存，可以说它是一个更加轻量级的界面载体。如果说我们的应用里有一百个界面，如果全用 Activity 来进行实现的话，那么整个应用跑起来以后内存的消耗是极大的，而如果采用 Activity+Fragment 的实现方式，则可大大降低内存的消耗。所以 Fragment 在 Android 开发者当中是十分收欢迎的。</p>
<p>你可以把 Fragment 当成 Activity 一个界面的一部分，甚至 Activity 的界面由完全不同的 Fragment 组成，更帅气的是 Fragment 有自己的声明周期和接收、处理用户的事件，这样就不必要在一个 Activity 里面写一堆事件、控件的代码了。更为重要的是，你可以动态的添加、替换、移除某个 Fragment 。</p>
<h3 id="fragment-和-activity-的关系"><a class="markdownIt-Anchor" href="#fragment-和-activity-的关系"></a> Fragment 和 Activity 的关系</h3>
<ul>
<li>Fragment 是依赖于 Activity 的，不能独立存在的。</li>
<li>一个 Activity 里可以有多个 Fragment。</li>
<li>一个 Fragment 可以被多个 Activity 重用。</li>
<li>Fragment 有自己的生命周期，并能接收输入事件。</li>
<li>我们能在 Activity 运行时动态地添加或删除 Fragment 。</li>
</ul>
<h4 id="fragment-和-activity-的两者的生命周期"><a class="markdownIt-Anchor" href="#fragment-和-activity-的两者的生命周期"></a> Fragment 和 Activity 的两者的生命周期</h4>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/lifespan.webp" alt="生命周期" /></p>
<p>可以看到 Fragment 比 Activity 多了几个额外的生命周期回调函数：</p>
<ul>
<li>onAttach(Activity);　　<strong>//当 Activity 与 Fragment 发生关联时调用</strong></li>
<li>onCreateView(LayoutInflater,ViewGroup,Bundle);　　<strong>//创建该 Fragment 的视图</strong></li>
<li>onActivityCreate(bundle);　　<strong>//当 Activity 的 onCreate() ；方法返回时调用</strong></li>
<li>onDestoryView();　　<strong>//与 onCreateView 相对应，当改 Fragment 被移除时调用</strong></li>
<li>onDetach();　　<strong>//与 onAttach() 相对应，当 Fragment 与 Activity 的关联被取消时调用</strong></li>
</ul>
<p>注意：除了 onCreateView ，其他的所有方法如果你重写了，必须调用父类对于该方法的实现。</p>
<h2 id="fragment-优势"><a class="markdownIt-Anchor" href="#fragment-优势"></a> Fragment 优势</h2>
<ul>
<li>模块化（Modularity）：我们不必把所有代码全部写在 Activity 中，而是把代码写在各自的 Fragment 中。</li>
<li>可重用（Reusability）：多个 Activity 可以重用一个 Fragment 。</li>
<li>可适配（Adaptability）：根据硬件的屏幕尺寸、屏幕方向，能够方便地实现不同的布局，这样用户体验更好。</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/advantage.webp" alt="Fragment 优势" /></p>
<blockquote>
<p>在贵潮 Mobile3 中，打开左侧的 <code>Drawer</code> 中的任一按钮，弹出来的都是一个 <code>Fragment</code> 而不是 <code>Activity</code> 。</p>
</blockquote>
<p>同一个 app 内的界面切换 用 Fragment 比较合适，因为 Activity 比较重量级</p>
<p><code>Fragment</code> —— 轻量级，切换灵活</p>
<blockquote>
<p>Note: 如果需要向下兼容（兼容3.0以下的 Android ，即例如让 Android 2.3使用上 Fragment），有 support-fragment 库，由于现在找到 Android 4.0 以下的设备比找女朋友都难（并没有），所以本次内训不考虑向下兼容，统统是面向 Ice-Cream Sandwich 以上的 Android。</p>
</blockquote>
<h3 id="fragement-核心类"><a class="markdownIt-Anchor" href="#fragement-核心类"></a> Fragement 核心类</h3>
<p>Fragment 核心的类有：</p>
<ul>
<li>Fragment：Fragment 的基类，任何创建的 Fragment 都需要继承该类。</li>
<li>FragmentManager：管理和维护 Fragment 。他是抽象类，具体的实现类是-  FragmentManagerImpl。</li>
<li>FragmentTransaction：对 Fragment 的添加、删除等操作都需要通过事务方式进行。他是抽象类，具体的实现类是BackStackRecord。<br />
Nested Fragment（Fragment 内部嵌套 Fragment 的能力）是 Android 4.2 提出的，support-fragment 库可以兼容到1.6。通过 getChildFragmentManager() 能够获得管理子 Fragment 的 FragmentManager ，在子 Fragment 中可以通过getParentFragment() 获得父 Fragment。</li>
</ul>
<h2 id="使用方法"><a class="markdownIt-Anchor" href="#使用方法"></a> 使用方法</h2>
<h3 id="把-fragment-当作控件使用静态使用"><a class="markdownIt-Anchor" href="#把-fragment-当作控件使用静态使用"></a> 把 Fragment 当作控件使用（静态使用）</h3>
<p>接下来，就是实践的时候了，要注意了，开始写代码喽~~~~</p>
<p>这种方法是使用 Fragment 的最简单的一种方式了，我们只需要声明一个类继承自 Fragment 实现其 onCreateView 方法，并将 fragment 声明在 Activity 的 xml 里即可。我们来看代码：</p>
<p>步骤：</p>
<p>1、继承 Fragment，重写 onCreateView 决定 Fragment 布局。</p>
<p>2、在 Activity 中声明此 Fragment , 就当和普通的 View 一样。</p>
<p>我们来看代码：</p>
<h4 id="afragmentjava"><a class="markdownIt-Anchor" href="#afragmentjava"></a> AFragment.java</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.young.fragmentdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> inflater.inflate(R.layout.afragment, container, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="afragmentxml"><a class="markdownIt-Anchor" href="#afragmentxml"></a> afragment.xml</h4>
<p>AFragment 的布局文件，在这里我们可以看出，我们可以每个 Fragment 当中进行单独的布局：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">        android:layout_centerInParent=<span class="string">&quot;true&quot;</span></span><br><span class="line">        android:text=<span class="string">&quot;钥匙天下第一！&quot;</span> /&gt;</span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: 将字符串放在布局文件xml里是不稳健的方法，应当放到res-&gt;values-&gt;strings.xml，以适应多语言种类。然而在这里，千言万语汇成一句：“钥匙牛逼！”</p>
</blockquote>
<h4 id="activity_mainxml"><a class="markdownIt-Anchor" href="#activity_mainxml"></a> activity_main.xml</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:orientation=<span class="string">&quot;vertical&quot;</span></span><br><span class="line">    tools:context=<span class="string">&quot;com.example.young.fragmentdemo.MainActivity&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;fragment</span><br><span class="line">        android:id=<span class="string">&quot;@+id/fragmenta&quot;</span></span><br><span class="line">        android:name=<span class="string">&quot;com.example.young.fragmentdemo.AFragment&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>这样我们就将 AFragment 作为一个控件显示出来了,十分简单，只是需要注意 fragment 控件一定要加 id 属性即可，否则会崩溃。</p>
<p>这里给出 Fragment 稍微完整的使用方式。首先，创建继承 Fragment 的类，名为 Fragment1 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fragment1</span> <span class="keyword">extends</span> <span class="title">Fragment</span></span>&#123;  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String ARG_PARAM = <span class="string">&quot;param_key&quot;</span>; </span><br><span class="line">     <span class="keyword">private</span> String mParam; </span><br><span class="line">     <span class="keyword">private</span> Activity mActivity; </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mActivity = (Activity) context;</span><br><span class="line">        mParam = getArguments().getString(ARG_PARAM);  <span class="comment">//获取参数</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        View root = inflater.inflate(R.layout.fragment_1, container, <span class="keyword">false</span>);</span><br><span class="line">        TextView view = root.findViewById(R.id.text);</span><br><span class="line">        view.setText(mParam);</span><br><span class="line">             <span class="keyword">return</span> root;</span><br><span class="line">    &#125;    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Fragment1 <span class="title">newInstance</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        Fragment1 frag = <span class="keyword">new</span> Fragment1();</span><br><span class="line">        Bundle bundle = <span class="keyword">new</span> Bundle();</span><br><span class="line">        bundle.putString(ARG_PARAM, str);</span><br><span class="line">        fragment.setArguments(bundle);   <span class="comment">//设置参数</span></span><br><span class="line">        <span class="keyword">return</span> fragment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再次复习！</p>
<ol>
<li>什么是LayoutInFlater？</li>
<li>什么是ViewGroup?</li>
<li>什么是Bundle？</li>
</ol>
<p><strong>ANSWER</strong></p>
<h2 id="layoutinflater布局服务"><a class="markdownIt-Anchor" href="#layoutinflater布局服务"></a> layoutInflater(布局服务)</h2>
<p>说到布局，大家第一时间 可能想起的是写完一个布局的xml，然后调用Activity的setContentView()加载布局，然后把他显示到屏幕上是吧~其实这个底层走的还是这个LayoutInflater，用的Android内置的Pull解析器来解析布局。一般在Android动态加载布局或者添加控件用得较多。</p>
<h2 id="viewgroup"><a class="markdownIt-Anchor" href="#viewgroup"></a> ViewGroup</h2>
<p>Android的UI界面都是由View和ViewGroup及其派生类组合而成的。其中，View是所有UI组件的基类，而ViewGroup是容纳View及其派生类的容器，ViewGroup也是从View派生出来的。一般来说，开发UI界面都不会直接使用View和ViewGroup（自定义控件的时候使用），而是使用其派生类。</p>
<h2 id="bundle"><a class="markdownIt-Anchor" href="#bundle"></a> Bundle</h2>
<p>Bundle主要用于传递数据；它保存的数据，是以key-value(键值对)的形式存在的。</p>
<p>我们经常使用Bundle在Activity之间传递数据，传递的数据可以是boolean、byte、int、long、float、double、string等基本类型或它们对应的数组，也可以是对象或对象数组。当Bundle传递的是对象或对象数组时，必须实现<a target="_blank" rel="noopener" href="http://blog.csdn.net/mer1234567/article/details/7841657">Serializable 或Parcelable</a>接口。下面分别介绍Activity之间如何传递基本类型、传递对象。</p>
</blockquote>
<p>Fragment 有很多可以复写的方法，其中最常用的就是 onCreateView()，该方法返回 Fragment 的UI布局，需要注意的是 inflate() 的第三个参数是 false ，因为在 Fragment 内部实现中，会把该布局添加到 container 中，如果设为 true ，那么就会重复做两次添加，则会抛出异常。</p>
<p>如果在创建 Fragment 时要传入参数，必须要通过 setArguments(Bundle bundle) 方式添加，而不建议通过为 Fragment 添加带参数的构造函数，因为通过 setArguments() 方式添加，在由于内存紧张导致 Fragment 被系统杀掉并恢复（re-instantiate）时能保留这些数据。</p>
<p>我们可以在Fragment的<code>onAttach()</code>中通过<code>getArguments()</code>获得传进来的参数，并在之后使用这些参数。如果要获取Activity对象，不建议调用<code>getActivity()</code>，而是在<code>onAttach()</code>中将Context对象强转为Activity对象。</p>
<p>创建完Fragment后，接下来就是把Fragment添加到Activity中。在Activity中添加Fragment的方式有两种：</p>
<ul>
<li>静态添加：在xml中添加，缺点是一旦添加就不能在运行时删除。</li>
<li>动态添加：运行时添加，这种方式比较灵活，因此建议使用这种方式。</li>
</ul>
<p>虽然Fragment能在XML中添加，但是这只是一个语法糖而已，Fragment并不是一个View，而是和Activity同一层次的。</p>
<h3 id="动态加载-fragment"><a class="markdownIt-Anchor" href="#动态加载-fragment"></a> 动态加载 Fragment</h3>
<p>首先Activity需要有一个容器存放Fragment，一般是FrameLayout，因此在Activity的布局文件中加入FrameLayout：</p>
<p>在代码中通过 FragmentManager 获取 FragmentTransaction 来进行 Fragment 的动态添加才是我们最常用的使用方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FrameLayout</span><br><span class="line">    android:id=<span class="string">&quot;@+id/container&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>然后在<code>onCreate()</code>中，通过以下代码将Fragment添加进Activity中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bundle == <span class="keyword">null</span>) &#123;</span><br><span class="line">    getSupportFragmentManager().beginTransaction()</span><br><span class="line">        .add(R.id.container, Fragment1.newInstance(<span class="string">&quot;hello world&quot;</span>), <span class="string">&quot;f1&quot;</span>)        <span class="comment">//.addToBackStack(&quot;fname&quot;)</span></span><br><span class="line">        .commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意几点：</p>
<ul>
<li>
<p>因为我们使用了 support 库的 Fragment ，因此需要使用<code>getSupportFragmentManager()</code>获取FragmentManager 。</p>
</li>
<li>
<p><code>add()</code>是对 Fragment 众多操作中的一种，还有<code>remove()</code>, <code>replace()</code>等，第一个参数是根容器的id（FrameLayout 的 id，即”@id/container”），第二个参数是 Fragment 对象，第三个参数是 fragment 的 tag 名，指定 tag 的好处是后续我们可以通过<code>Fragment1 frag = getSupportFragmentManager().findFragmentByTag(&quot;f1&quot;)</code>从 FragmentManager 中查找 Fragment 对象。</p>
</li>
<li>
<p>在一次事务中，可以做多个操作，比如同时做<code>add().remove().replace()</code>。</p>
</li>
<li>
<p><code>commit()</code>操作是异步的，内部通过<code>mManager.enqueueAction()</code>加入处理队列。对应的同步方法为<code>commitNow()</code>，<code>commit()</code>内部会有<code>checkStateLoss()</code>操作，如果开发人员使用不当（比如<code>commit()</code>操作在<code>onSaveInstanceState()</code>之后），可能会抛出异常，而<code>commitAllowingStateLoss()</code>方法则是不会抛出异常版本的<code>commit()</code>方法，但是尽量使用<code>commit()</code>，而不要使用<code>commitAllowingStateLoss()</code>。</p>
</li>
<li>
<p><code>addToBackStack(&quot;fname&quot;)</code>是可选的。FragmentManager 拥有回退栈（BackStack），类似于 Activity 的任务栈，如果添加了该语句，就把该事务加入回退栈，当用户点击返回按钮，会回退该事务（回退指的是如果事务是<code>add(frag1)</code>，那么回退操作就是<code>remove(frag1)</code>）；如果没添加该语句，用户点击返回按钮会直接销毁Activity。</p>
</li>
<li>
<p>Fragment 有一个常见的问题，即 Fragment 重叠问题，这是由于 Fragment 被系统杀掉，并重新初始化时再次将 fragment 加入 activity ，因此通过在外围加 if 语句能判断此时是否是被系统杀掉并重新初始化的情况。</p>
<p>Fragment 有个常见的异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Can not perform <span class="keyword">this</span> action after onSaveInstanceState</span><br><span class="line">    at android.support.v4.app.FragmentManagerImpl.checkStateLoss(FragmentManager.java:<span class="number">1341</span>)</span><br><span class="line">    at android.support.v4.app.FragmentManagerImpl.enqueueAction(FragmentManager.java:<span class="number">1352</span>)</span><br><span class="line">    at android.support.v4.app.BackStackRecord.commitInternal(BackStackRecord.java:<span class="number">595</span>)</span><br><span class="line">    at android.support.v4.app.BackStackRecord.commit(BackStackRecord.java:<span class="number">574</span>)</span><br></pre></td></tr></table></figure>
<p>该异常出现的原因是：<code>commit()</code>在<code>onSaveInstanceState()</code>后调用。首先，<code>onSaveInstanceState()</code>在<code>onPause()</code>之后，<code>onStop()</code>之前调用。<code>onRestoreInstanceState()</code>在<code>onStart()</code>之后，<code>onResume()</code>之前。</p>
</li>
</ul>
<p><strong>因此避免出现该异常的方案有：</strong></p>
<ul>
<li>不要把Fragment事务放在异步线程的回调中，比如不要把Fragment事务放在AsyncTask的<code>onPostExecute()</code>，因此<code>onPostExecute()</code>可能会在<code>onSaveInstanceState()</code>之后执行。</li>
<li>逼不得已时使用<code>commitAllowingStateLoss()</code>。</li>
</ul>
<p>上面的内容有点大，我们先来看看一个比较简单的例子。</p>
<p>先来看代码：</p>
<h4 id="mainactivityjava"><a class="markdownIt-Anchor" href="#mainactivityjava"></a> MainActivity.java</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.young.fragmentdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        AFragment mAFragment = <span class="keyword">new</span> AFragment();</span><br><span class="line">        getFragmentManager().beginTransaction()</span><br><span class="line">                .replace(R.id.main_container, mAFragment).commit();</span><br><span class="line">        getFragmentManager().beginTransaction().show(mAFragment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="activity_mainxml-2"><a class="markdownIt-Anchor" href="#activity_mainxml-2"></a> activity_main.xml</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    xmlns:tools=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span><br><span class="line">    android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:orientation=<span class="string">&quot;vertical&quot;</span></span><br><span class="line">    tools:context=<span class="string">&quot;com.example.young.fragmentdemo.MainActivity&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">        android:id=<span class="string">&quot;@+id/main_container&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/LinearLayout&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们在 Activity 中获取 FragmentManager 然后再进一步获取到 FragmentTransaction 对象将我们 new 出来的 AFragment add 到 FrameLayout 中。</p>
<p>这种动态加载 Fragment 的方式十分灵活，可以让我们在代码当中动态的决定加载哪些 Fragment 显示出来。这里我们需要重点关注的是 FragmentTransaction 对象。除了例子当中使用的 add 操作以外，它还有 replace,hide,show,remove 等操作，下面就对这几种方法一一进行解释。</p>
<h4 id="1addint-containerviewid-fragment-fragment"><a class="markdownIt-Anchor" href="#1addint-containerviewid-fragment-fragment"></a> 1)add(int containerViewId, Fragment fragment)</h4>
<p>这个方法是将fragmen添加到我们指定id的layout中.</p>
<h4 id="2hidefragment-fragment和showfragment-fragment"><a class="markdownIt-Anchor" href="#2hidefragment-fragment和showfragment-fragment"></a> 2)hide(Fragment fragment)和show(Fragment fragment)</h4>
<p>隐藏或者显示指定的fragment，类似于我们在View中经常使用的setVisibly方法，需要注意的是，这里的hide和show仅仅只是让fragment显示和隐藏，不会对fragment进行销毁，甚至我们在hide的时候fragment的onPause方法都没有被调用。</p>
<h4 id="3removefragment-fragment"><a class="markdownIt-Anchor" href="#3removefragment-fragment"></a> 3)remove(Fragment fragment)</h4>
<p>会将fragment移除，如果被移除的Fragment没有添加到回退栈,该Fragment会同时被销毁。</p>
<h4 id="4replaceint-containerviewid-fragment-fragment"><a class="markdownIt-Anchor" href="#4replaceint-containerviewid-fragment-fragment"></a> 4)replace(int containerViewId, Fragment fragment)</h4>
<p>replace方法是用来进行替换的，实际上也就是对指定的layout id先remove掉其fragment,然后再add上去我们指定的fragment的一种组合操作。</p>
<h4 id="5detach"><a class="markdownIt-Anchor" href="#5detach"></a> 5)detach()</h4>
<p>会将view从UI中移除,和remove()不同,此时fragment并没有与Activity断绝关系，所以生命周期的onDestroy方法和onDetach方法并没有被调用</p>
<h4 id="6attach"><a class="markdownIt-Anchor" href="#6attach"></a> 6)attach()</h4>
<p>重建view视图，附加到UI上并显示，如果调用完detach方法后再来调用该方法的话不会去走onAttach和onCreate方法。</p>
<p>需要注意的是，我们在进行了上述的各种操作以后一定要调用commit方法提交事务才能生效。</p>
<h2 id="fragment-与生命周期有关方法"><a class="markdownIt-Anchor" href="#fragment-与生命周期有关方法"></a> Fragment 与生命周期有关方法</h2>
<h3 id="1onattach"><a class="markdownIt-Anchor" href="#1onattach"></a> 1).onAttach</h3>
<p>当该Fragment与Activity发生关联的时候调用，注意的是这个方法里会给我们传入一个Context上下文参数，此时我们可以将其存入成员变量中进行使用，避免在代码中调用getActivity()出现的空指针异常。</p>
<h3 id="2oncreate"><a class="markdownIt-Anchor" href="#2oncreate"></a> 2).onCreate</h3>
<p>当创建Fragment的时候调用与onAttach方法是一起调用的，如果没有调用到onAttach方法就不会调用该方法。</p>
<h3 id="3oncreateview"><a class="markdownIt-Anchor" href="#3oncreateview"></a> 3).onCreateView</h3>
<p>每次创建、绘制Fragment的View时调用，并且返回一个view对象。</p>
<h3 id="4onactivitycreated"><a class="markdownIt-Anchor" href="#4onactivitycreated"></a> 4).onActivityCreated</h3>
<p>当Fragment所在的Activity被onCreate完成时调用。</p>
<h3 id="5ondestoryview"><a class="markdownIt-Anchor" href="#5ondestoryview"></a> 5)onDestoryView()</h3>
<p>与onCreateView想对应，当该Fragment的视图被移除时调用。</p>
<h3 id="6ondestroy方法"><a class="markdownIt-Anchor" href="#6ondestroy方法"></a> 6)onDestroy()方法</h3>
<p>与onCreate想对应当Fragment的状态被销毁的时候进行调用。</p>
<h3 id="7ondetach"><a class="markdownIt-Anchor" href="#7ondetach"></a> 7)onDetach()</h3>
<p>与onAttach相对应，当Fragment与Activity关联被取消时调用，需要注意的是我们调用detach方法的时候并不会调用到该生命周期方法。</p>
<p><strong>上面的方法中，只有onCreateView()在重写时不用写super方法，其他都需要。</strong></p>
<h2 id="fragment-实现原理和-back-stack"><a class="markdownIt-Anchor" href="#fragment-实现原理和-back-stack"></a> Fragment 实现原理和 Back Stack</h2>
<p>我们知道 Activity 有任务栈，用户通过 startActivity 将 Activity 加入栈，点击返回按钮将 Activity 出栈。Fragment 也有类似的栈，称为回退栈（Back Stack），回退栈是由 FragmentManager 管理的。默认情况下，Fragment 事务是不会加入回退栈的，如果想将 Fragment 事务加入回退栈，则可以加入<code>addToBackStack(&quot;&quot;)</code>。如果没有加入回退栈，则用户点击返回按钮会直接将 Activity 出栈；如果加入了回退栈，则用户点击返回按钮会回滚 Fragment 事务。</p>
<p>我们将通过最常见的 Fragment 用法，讲解 Back Stack 的实现原理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getSupportFragmentManager().beginTransaction()</span><br><span class="line">    .add(R.id.container, f1, <span class="string">&quot;f1&quot;</span>)</span><br><span class="line">    .addToBackStack(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    .commit();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面这个代码的功能就是将 Fragment 加入 Activity 中，内部实现为：创建一个 BackStackRecord 对象，该对象记录了这个事务的全部操作轨迹（这里只做了一次 add 操作，并且加入回退栈），随后将该对象提交到FragmentManager 的执行队列中，等待执行。</p>
<p>BackStackRecord 类的定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class BackStackRecord extends FragmentTransaction implements FragmentManager.BackStackEntry, Runnable &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从定义可以看出，BackStackRecord 有三重含义：</p>
<ul>
<li>继承了 FragmentTransaction ，即是事务，保存了整个事务的全部操作轨迹。</li>
<li>实现了 BackStackEntry ，作为回退栈的元素，正是因为该类拥有事务全部的操作轨迹，因此在 popBackStack() 时能回退整个事务。</li>
<li>继承了 Runnable ，即被放入 FragmentManager 执行队列，等待被执行。</li>
</ul>
<p>先看第一层含义，<code>getSupportFragmentManager.beginTransaction()</code>返回的就是 BackStackRecord 对象，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BackStackRecord(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>BackStackRecord 类包含了一次事务的整个操作轨迹，是以链表形式存在的，链表的元素是 Op 类，表示其中某个操作，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Op</span> </span>&#123;</span><br><span class="line">    Op next; <span class="comment">//链表后一个节点</span></span><br><span class="line">    Op prev; <span class="comment">//链表前一个节点</span></span><br><span class="line">    <span class="keyword">int</span> cmd;  <span class="comment">//操作是add或remove或replace或hide或show等</span></span><br><span class="line">    Fragment fragment; <span class="comment">//对哪个Fragment对象做操作&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们来看下具体场景下这些类是怎么被使用的，比如我们的事务做 add 操作。add 函数的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FragmentTransaction <span class="title">add</span><span class="params">(<span class="keyword">int</span> containerViewId, Fragment fragment, String tag)</span> </span>&#123;</span><br><span class="line">    doAddOp(containerViewId, fragment, tag, OP_ADD);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>doAddOp() 方法就是创建 Op 对象，并加入链表，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAddOp</span><span class="params">(<span class="keyword">int</span> containerViewId, Fragment fragment, String tag, <span class="keyword">int</span> opcmd)</span> </span>&#123;</span><br><span class="line">    fragment.mTag = tag;  <span class="comment">//设置fragment的tag</span></span><br><span class="line">    fragment.mContainerId = fragment.mFragmentId = containerViewId;  <span class="comment">//设置fragment的容器id</span></span><br><span class="line">    Op op = <span class="keyword">new</span> Op();</span><br><span class="line">    op.cmd = opcmd;</span><br><span class="line">    op.fragment = fragment;</span><br><span class="line">    addOp(op);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>addOp() 是将创建好的 Op 对象加入链表，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addOp</span><span class="params">(Op op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHead == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mHead = mTail = op;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        op.prev = mTail;</span><br><span class="line">        mTail.next = op;</span><br><span class="line">        mTail = op;</span><br><span class="line">    &#125;</span><br><span class="line">    mNumOp++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>addToBackStack(“”)</code>是将 mAddToBackStack 变量记为 true ，在<code>commit()</code>中会用到该变量。<code>commit()</code>是异步的，即不是立即生效的，但是后面会看到整个过程还是在主线程完成，只是把事务的执行扔给主线程的 Handler ，<code>commit()</code>内部是<code>commitInternal()</code>，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commitInternal</span><span class="params">(<span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">    mCommitted = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mAddToBackStack) &#123;</span><br><span class="line">        mIndex = mManager.allocBackStackIndex(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mManager.enqueueAction(<span class="keyword">this</span>, allowStateLoss); <span class="comment">//将事务添加进待执行队列中</span></span><br><span class="line">    <span class="keyword">return</span> mIndex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果 mAddToBackStack 为 true ，则调用<code>allocBackStackIndex(this)</code>将事务添加进回退栈， FragmentManager 类的变量 ArrayListmBackStackIndices ;就是回退栈。实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">allocBackStackIndex</span><span class="params">(BackStackRecord bse)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBackStackIndices == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mBackStackIndices = <span class="keyword">new</span> ArrayList&lt;BackStackRecord&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> index = mBackStackIndices.size();</span><br><span class="line">    mBackStackIndices.add(bse);</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>commitInternal()</code>中，<code>mManager.enqueueAction(this, allowStateLoss)</code>;是将 BackStackRecord 加入待执行队列中，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueAction</span><span class="params">(Runnable action, <span class="keyword">boolean</span> allowStateLoss)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPendingActions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mPendingActions = <span class="keyword">new</span> ArrayList&lt;Runnable&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    mPendingActions.add(action);</span><br><span class="line">    <span class="keyword">if</span> (mPendingActions.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        mHost.getHandler().removeCallbacks(mExecCommit);</span><br><span class="line">        mHost.getHandler().post(mExecCommit); <span class="comment">//调用execPendingActions()执行待执行队列的事务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>mPendingActions 就是前面说的待执行队列，<code>mHost.getHandler()</code>就是主线程的 Handler，因此 Runnable 是在主线程执行的，mExecCommit 的内部就是调用了<code>execPendingActions()</code>，即把 mPendingActions 中所有积压的没被执行的事务全部执行。执行队列中的事务会怎样被执行呢？就是调用<code>BackStackRecord的run()</code>方法，<code>run()</code>方法就是执行 Fragment 的生命周期函数，还有将视图添加进 container 中。</p>
<p>与<code>addToBackStack()</code>对应的是<code>popBackStack()</code>，有以下几种变种：</p>
<ul>
<li>popBackStack()：将回退栈的栈顶弹出，并回退该事务。</li>
<li>popBackStack(String name, int flag)：name 为 addToBackStack(String name) 的参数，通过 name能找到回退栈的特定元素，flag 可以为 0 或者 FragmentManager.POP_BACK_STACK_INCLUSIVE，0 表示只弹出该元素以上的所有元素，POP_BACK_STACK_INCLUSIVE 表示弹出包含该元素及以上的所有元素。这里说的弹出所有元素包含回退这些事务。</li>
<li>popBackStack() 是异步执行的，是丢到主线程的 MessageQueue 执行，popBackStackImmediate() 是同步版本。</li>
</ul>
<p>我们通过讲解 Demo1 来更清晰地了解回退栈的使用。功能如下：共有三个 Fragment：F1, F2, F3，F1 在初始化时就加入Activity，点击F1中的按钮跳转到F2，点击F2的按钮跳转到F3，点击F3的按钮回退到F1。</p>
<p>在Activity的 onCreate() 中，将F1加入Activity中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getSupportFragmentManager().beginTransaction()</span><br><span class="line">    .add(R.id.container, f1, <span class="string">&quot;f1&quot;</span>)</span><br><span class="line">    .addToBackStack(Fragment1.class.getSimpleName())</span><br><span class="line">    .commit();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>F1按钮的 onClick() 内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getFragmentManager().beginTransaction()</span><br><span class="line">    .replace(R.id.container, f2, <span class="string">&quot;f2&quot;</span>)</span><br><span class="line">    .addToBackStack(Fragment2.class.getSimpleName())</span><br><span class="line">    .commit();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>F2按钮的 onClick() 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getFragmentManager().beginTransaction()</span><br><span class="line">    .replace(R.id.container, f3, <span class="string">&quot;f3&quot;</span>)</span><br><span class="line">    .addToBackStack(Fragment3.class.getSimpleName())</span><br><span class="line">    .commit();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>F3按钮的 onClick() 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getFragmentManager().popBackStack(Fragment2.class.getSimpleName(), FragmentManager.POP_BACK_STACK_INCLUSIVE);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样就完成了整个界面的跳转逻辑。</p>
<p>这里补充一个点<br />
<code>getSupportFragmentManager().findFragmentByTag()</code>是经常用到的方法，他是 FragmentManager 的方法，FragmentManager 是抽象类，FragmentManagerImpl 是继承 FragmentManager 的实现类，他的内部实现是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FragmentManagerImpl</span> <span class="keyword">extends</span> <span class="title">FragmentManager</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Fragment&gt; mActive;</span><br><span class="line">    ArrayList&lt;Fragment&gt; mAdded;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Fragment <span class="title">findFragmentByTag</span><span class="params">(String tag)</span> </span>&#123; </span><br><span class="line">           <span class="keyword">if</span> (mAdded != <span class="keyword">null</span> &amp;&amp; tag != <span class="keyword">null</span>) &#123; </span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i=mAdded.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                Fragment f = mAdded.get(i);</span><br><span class="line">                <span class="keyword">if</span> (f != <span class="keyword">null</span> &amp;&amp; tag.equals(f.mTag)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> f;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;       </span><br><span class="line">          <span class="keyword">if</span> (mActive != <span class="keyword">null</span> &amp;&amp; tag != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i=mActive.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    Fragment f = mActive.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (f != <span class="keyword">null</span> &amp;&amp; tag.equals(f.mTag)) &#123;</span><br><span class="line">                          <span class="keyword">return</span> f;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从上面看到，先从 mAdded 中查找是否有该 Fragment ，如果没找到，再从 mActive 中查找是否有该Fragment 。mAdded 是已经添加到 Activity 的 Fragment 的集合，mActive 不仅包含 mAdded ，还包含虽然不在 Activity 中，但还在回退栈中的 Fragment。</p>
<h2 id="fragment通信"><a class="markdownIt-Anchor" href="#fragment通信"></a> Fragment通信</h2>
<h3 id="fragment向activity传递数据"><a class="markdownIt-Anchor" href="#fragment向activity传递数据"></a> Fragment向Activity传递数据</h3>
<p>首先，在 Fragment 中定义接口，并让 Activity 实现该接口（具体实现省略）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnFragmentInteractionListener</span> </span>&#123;    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(String str)</span></span>;  <span class="comment">//将str从Fragment传递给Activity&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在 Fragment 的 onAttach() 中，将参数 Context 强转为 OnFragmentInteractionListener 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onAttach(context);</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> OnFragmentInteractionListener) &#123;</span><br><span class="line">        mListener = (OnFragmentInteractionListener) context;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(context.toString()</span><br><span class="line">                + <span class="string">&quot; must implement OnFragmentInteractionListener&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>并在 Fragment 合适的地方调用<code>mListener.onItemClick(&quot;hello&quot;)</code>将 ”hello” 从 Fragment 传递给 Activity 。</p>
<h3 id="fabridge"><a class="markdownIt-Anchor" href="#fabridge"></a> FABridge</h3>
<p>由于通过接口的方式从 Fragment 向 Activity 进行数据传递比较麻烦，需要在 Fragment 中定义 interface ，并让 Activity 实现该 interface ，FABridge(<a target="_blank" rel="noopener" href="https://github.com/hongyangAndroid/FABridge">https://github.com/hongyangAndroid/FABridge</a>) 通过注解的形式免去了这些定义。</p>
<p>在 build.gradle 中添加依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotationProcessor <span class="string">&#x27;com.zhy.fabridge:fabridge-compiler:1.0.0&#x27;</span>compile <span class="string">&#x27;com.zhy.fabridge:fabridge-api:1.0.0&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先定义方法 ID，这里为 FAB_ITEM_CLICK ，接着在 Activity 中定义接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FCallbackId(id = FAB_ITEM_CLICK)</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(String str)</span> </span>&#123;  <span class="comment">//方法名任意</span></span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, str, Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后，在 Fragment 中，通过以下形式调用 ”ID=FAB_ITEM_CLICK” 的方法（该方法可能在 Activity 中，也可能在任何类中）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Fabridge.call(mActivity,FAB_ITEM_CLICK,<span class="string">&quot;data&quot;</span>);  <span class="comment">//调用ID对应的方法，&quot;data&quot;为参数值</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="activity-向-fragment-传递数据"><a class="markdownIt-Anchor" href="#activity-向-fragment-传递数据"></a> Activity 向 Fragment 传递数据</h3>
<p>Activity 向 Fragment 传递数据比较简单，获取 Fragment 对象，并调用 Fragment 的方法即可，比如要将一个字符串传递给 Fragment，则在 Fragment 中定义方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String str)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">this</span>.str = str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>并在 Activity 中调用<code>fragment.setString(&quot;hello&quot;)</code>即可。</p>
<h3 id="fragment-之间通信"><a class="markdownIt-Anchor" href="#fragment-之间通信"></a> Fragment 之间通信</h3>
<p>由于Fragment之间是没有任何依赖关系的，因此如果要进行Fragment之间的通信，建议通过Activity作为中介，不要Fragment之间直接通信。</p>
<h3 id="dialogfragment"><a class="markdownIt-Anchor" href="#dialogfragment"></a> DialogFragment</h3>
<p>DialogFragment是Android 3.0提出的，代替了Dialog，用于实现对话框。他的优点是：即使旋转屏幕，也能保留对话框状态。</p>
<p>如果要自定义对话框样式，只需要继承DialogFragment，并重写<code>onCreateView()</code>，该方法返回对话框UI。这里我们举个例子，实现进度条样式的圆角对话框。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgressDialogFragment</span> <span class="keyword">extends</span> <span class="title">DialogFragment</span> </span>&#123;    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        getDialog().requestWindowFeature(Window.FEATURE_NO_TITLE); <span class="comment">//消除Title区域</span></span><br><span class="line">        getDialog().getWindow().setBackgroundDrawable(<span class="keyword">new</span> ColorDrawable(Color.TRANSPARENT));  <span class="comment">//将背景变为透明</span></span><br><span class="line">        setCancelable(<span class="keyword">false</span>);  <span class="comment">//点击外部不可取消</span></span><br><span class="line">        View root = inflater.inflate(R.layout.fragment_progress_dialog, container);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProgressDialogFragment <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProgressDialogFragment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进度条动画我们使用 Lottie(<a target="_blank" rel="noopener" href="https://github.com/airbnb/lottie-android">https://github.com/airbnb/lottie-android</a>)实现，Lottie 动画从这里(<a target="_blank" rel="noopener" href="https://www.lottiefiles.com/">https://www.lottiefiles.com/</a>)找到。使用非常方便，只需要下载 JSON 动画文件，然后在 XML 中写入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.airbnb.lottie.LottieAnimationView</span><br><span class="line">    android:layout_width=<span class="string">&quot;wrap_content&quot;</span>  <span class="comment">//大小根据JSON文件确定</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    app:lottie_fileName=<span class="string">&quot;loader_ring.json&quot;</span>   <span class="comment">//JSON文件</span></span><br><span class="line">    app:lottie_loop=<span class="string">&quot;true&quot;</span>    <span class="comment">//循环播放</span></span><br><span class="line">    app:lottie_autoPlay=<span class="string">&quot;true&quot;</span> /&gt;  <span class="comment">//自动播放</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后通过下面代码显示对话框：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProgressDialogFragment fragment = ProgressDialogFragment.newInstance();</span><br><span class="line">fragment.show(getSupportFragmentManager(), <span class="string">&quot;tag&quot;</span>);<span class="comment">//fragment.dismiss();</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>为了实现圆角，除了在 onCreateView() 中把背景设为透明，还需要对UI加入背景：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;shape xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span><br><span class="line">    &lt;solid android:color=<span class="string">&quot;#ffffff&quot;</span>/&gt;</span><br><span class="line">    &lt;corners</span><br><span class="line">        android:radius=<span class="string">&quot;20dp&quot;</span>/&gt;</span><br><span class="line">&lt;/shape&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="fragment的典型应用场景"><a class="markdownIt-Anchor" href="#fragment的典型应用场景"></a> Fragment的典型应用场景</h2>
<p>Fragment的应用场景最多的便是 ViewPager+Fragment 的实现，现在主流的 APP 几乎都能看到它们的身影，那么这一部分我就主要针对该应用场景进行分析。</p>
<p>ViewPager是support v4库中提供界面滑动的类，继承自ViewGroup。PagerAdapter是ViewPager的适配器类，为ViewPager提供界面。但是一般来说，通常都会使用PagerAdapter的两个子类：FragmentPagerAdapter和FragmentStatePagerAdapter作为ViewPager的适配器，他们的特点是界面是Fragment。</p>
<p>默认，ViewPager会缓存当前页相邻的界面，比如当滑动到第2页时，会初始化第1页和第3页的界面（即Fragment对象，且生命周期函数运行到<code>onResume()</code>），可以通过<code>setOffscreenPageLimit(count)</code>设置离线缓存的界面个数。</p>
<p>FragmentPagerAdapter和FragmentStatePagerAdapter需要重写的方法都一样，常见的重写方法如下：</p>
<ul>
<li>public FragmentPagerAdapter(FragmentManager fm): 构造函数，参数为FragmentManager。如果是嵌套Fragment场景，子 PagerAdapter的参数传入getChildFragmentManager()。</li>
<li>Fragment getItem(int position): 返回第position位置的Fragment，必须重写。</li>
<li>int getCount(): 返回ViewPager的页数，必须重写。</li>
<li>Object instantiateItem(ViewGroup container, int position): container是ViewPager对象，返回第position位置的Fragment。</li>
<li>void destroyItem(ViewGroup container, int position, Object object): container是ViewPager对象，object是Fragment对象。</li>
<li>getItemPosition(Object object): object是Fragment对象，如果返回POSITION_UNCHANGED，则表示当前Fragment不刷新，如果返回POSITION_NONE，则表示当前Fragment需要调用<code>destroyItem()</code>和<code>instantiateItem()</code>进行销毁和重建。 默认情况下返回POSITION_UNCHANGED。</li>
</ul>
<h3 id="viewpagerfragment结构"><a class="markdownIt-Anchor" href="#viewpagerfragment结构"></a> ViewPager+Fragment结构</h3>
<p>首先我们来看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">            <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ViewPager mViewPager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Fragment&gt; mList;</span><br><span class="line">    <span class="keyword">private</span> Fragment mOne;</span><br><span class="line">    <span class="keyword">private</span> Fragment mTwo;</span><br><span class="line">    <span class="keyword">private</span> Fragment mThree;</span><br><span class="line">    <span class="keyword">private</span> Fragment mFour;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button mOneButton;</span><br><span class="line">    <span class="keyword">private</span> Button mTwoButton;</span><br><span class="line">    <span class="keyword">private</span> Button mThreeButton;</span><br><span class="line">    <span class="keyword">private</span> Button mFourButton;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mViewPager = (ViewPager) findViewById(R.id.content_pager);</span><br><span class="line">        <span class="comment">//加载Fragment</span></span><br><span class="line">        mList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        mOne = <span class="keyword">new</span> OneFragment();</span><br><span class="line">        mTwo = <span class="keyword">new</span> TwoFragment();</span><br><span class="line">        mThree = <span class="keyword">new</span> ThreeFragment();</span><br><span class="line">        mFour = <span class="keyword">new</span> FourFragment();</span><br><span class="line">        mList.add(mOne);</span><br><span class="line">        mList.add(mTwo);</span><br><span class="line">        mList.add(mThree);</span><br><span class="line">        mList.add(mFour);</span><br><span class="line"></span><br><span class="line">        mOneButton = (Button) findViewById(R.id.one);</span><br><span class="line">        mTwoButton = (Button) findViewById(R.id.two);</span><br><span class="line">        mThreeButton = (Button) findViewById(R.id.three);</span><br><span class="line">        mFourButton = (Button) findViewById(R.id.four);</span><br><span class="line"></span><br><span class="line">        mOneButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mTwoButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mThreeButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mFourButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置到ViewPager中</span></span><br><span class="line">        mViewPager.setAdapter(<span class="keyword">new</span> ContentsPagerAdapter(</span><br><span class="line">                getSupportFragmentManager()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.one :</span><br><span class="line">                mViewPager.setCurrentItem(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.two :</span><br><span class="line">                mViewPager.setCurrentItem(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.three :</span><br><span class="line">                mViewPager.setCurrentItem(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.four :</span><br><span class="line">                mViewPager.setCurrentItem(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ContentsPagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentStatePagerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ContentsPagerAdapter</span><span class="params">(FragmentManager fm)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(fm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mList.get(position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mList.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在这里我们加载了4个Fragment到ViewPager中，同时我在这里使用的是<br />
FragmentStatePagerAdapter 。这里需要提到的是 FragmentStatePagerAdapter 与 FragmentPagerAdapter 的区别。<br />
<strong>FragmentPagerAdapter</strong>：对于不再需要的fragment，仅仅只会调用到onDestroyView方法，也就是仅仅销毁视图而并没有完全销毁Fragment。<br />
<strong>FragmentStatePagerAdapter</strong>：会销毁不再需要的fragment，一直调用到 onDetach 方法失去与 Activity 的绑定。销毁时，会调用 onSaveInstanceState(Bundle outState) 方法通过 bundle 将信息保存下来，当用户切换回来，可以通过该 bundle 恢复生成新的 fragment ，也就是说，我们可以在 onSaveInstanceState(Bundle outState) 方法中保存一些数据，在 onCreate 中进行恢复创建。</p>
<h4 id="经验"><a class="markdownIt-Anchor" href="#经验"></a> 经验</h4>
<p>当页面较少的情况下可以考虑使用FragmentPagerAdapter，通过空间来换取时间上的效率。但当页面多了的时候我们就更需要使用FragmentStatePagerAdapter来做了，因为没有哪个用户希望某个应用会占爆它内存。</p>
<h3 id="懒加载"><a class="markdownIt-Anchor" href="#懒加载"></a> 懒加载</h3>
<p>懒加载主要用于ViewPager且每页是Fragment的情况，场景为微信主界面，底部有4个tab，当滑到另一个tab时，先显示”正在加载”，过一会才会显示正常界面。</p>
<p>默认情况，ViewPager会缓存当前页和左右相邻的界面。实现懒加载的主要原因是：用户没进入的界面需要有一系列的网络、数据库等耗资源、耗时的操作，预先做这些数据加载是不必要的。</p>
<p>这里懒加载的实现思路是：用户不可见的界面，只初始化UI，但是不会做任何数据加载。等滑到该页，才会异步做数据加载并更新UI。</p>
<p>这里就实现类似微信那种效果，整个UI布局为：底部用PagerBottomTabStrip(<a target="_blank" rel="noopener" href="https://github.com/tyzlmjj/PagerBottomTabStrip">https://github.com/tyzlmjj/PagerBottomTabStrip</a>)项目实现，上面是ViewPager，使用FragmentPagerAdapter。逻辑为：当用户滑到另一个界面，首先会显示正在加载，等数据加载完毕后（这里用睡眠1秒钟代替）显示正常界面。</p>
<p>ViewPager默认缓存左右相邻界面，为了避免不必要的重新数据加载（重复调用<code>onCreateView()</code>），因为有4个tab，因此将离线缓存的半径设置为3，即<code>setOffscreenPageLimit(3)</code>。</p>
<p>懒加载主要依赖Fragment的<code>setUserVisibleHint(boolean isVisible)</code>方法，当Fragment变为可见时，会调用<code>setUserVisibleHint(true)</code>；当Fragment变为不可见时，会调用<code>setUserVisibleHint(false)</code>，且该方法调用时机：</p>
<ul>
<li>
<p>onAttach()之前，调用<code>setUserVisibleHint(false)</code>。</p>
</li>
<li>
<p>onCreateView()之前，如果该界面为当前页，则调用<code>setUserVisibleHint(true)</code>，否则调用<code>setUserVisibleHint(false)</code>。</p>
</li>
<li>
<p>界面变为可见时，调用<code>setUserVisibleHint(true)</code>。<br />
*界面变为不可见时，调用<code>setUserVisibleHint(false)</code>。</p>
<p>懒加载Fragment的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;    <span class="keyword">private</span> View mRootView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsInited;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsPrepared;    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        mRootView = inflater.inflate(R.layout.fragment_lazy, container, <span class="keyword">false</span>);</span><br><span class="line">        mIsPrepared = <span class="keyword">true</span>;</span><br><span class="line">        lazyLoad();</span><br><span class="line">            <span class="keyword">return</span> mRootView;</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lazyLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getUserVisibleHint() &amp;&amp; mIsPrepared &amp;&amp; !mIsInited) &#123; </span><br><span class="line">               <span class="comment">//异步初始化，在初始化后显示正常UI</span></span><br><span class="line">            loadData();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">               </span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//1. 加载数据</span></span><br><span class="line">                <span class="comment">//2. 更新UI</span></span><br><span class="line">                <span class="comment">//3. mIsInited = true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;   </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserVisibleHint</span><span class="params">(<span class="keyword">boolean</span> isVisibleToUser)</span> </span>&#123; </span><br><span class="line">           <span class="keyword">super</span>.setUserVisibleHint(isVisibleToUser);</span><br><span class="line">            <span class="keyword">if</span> (isVisibleToUser) &#123;</span><br><span class="line">            lazyLoad();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyFragment <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> LazyFragment();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意点：</p>
<ul>
<li>在Fragment中有两个变量控制是否需要做数据加载：</li>
<li>
<ul>
<li>mIsPrepared：表示UI是否准备好，因为数据加载后需要更新UI，如果UI还没有inflate，就不需要做数据加载，因为setUserVisibleHint()会在onCreateView()之前调用一次，如果此时调用，UI还没有inflate，因此不能加载数据。</li>
<li>mIsInited：表示是否已经做过数据加载，如果做过了就不需要做了。因为setUserVisibleHint(true)在界面可见时都会调用，如果滑到该界面做过数据加载后，滑走，再滑回来，还是会调用setUserVisibleHint(true)，此时由于mIsInited=true，因此不会再做一遍数据加载。</li>
</ul>
</li>
<li>lazyLoad()：懒加载的核心类，在该方法中，只有界面可见（getUserVisibleHint()<mark>true）、UI准备好（mIsPrepared</mark>true）、过去没做过数据加载（mIsInited==false）时，才需要调loadData()做数据加载，数据加载做完后把mIsInited置为true。</li>
</ul>
<p>布局XML主要分两个container，一个是初始显示的状态，即R.id.container_empty，当数据加载完成，就显示R.id.container：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;FrameLayout xmlns:android=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="line">    android:orientation=<span class="string">&quot;vertical&quot;</span> android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;RelativeLayout</span><br><span class="line">        android:id=<span class="string">&quot;@+id/container_empty&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span>&gt;</span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:layout_width=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">            android:layout_height=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">            android:layout_centerInParent=<span class="string">&quot;true&quot;</span></span><br><span class="line">            android:text=<span class="string">&quot;正在加载&quot;</span></span><br><span class="line">            /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/RelativeLayout&gt;</span><br><span class="line">    &lt;RelativeLayout</span><br><span class="line">        android:id=<span class="string">&quot;@+id/container&quot;</span></span><br><span class="line">        android:layout_width=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:layout_height=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">        android:visibility=<span class="string">&quot;gone&quot;</span></span><br><span class="line">        &gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;/RelativeLayout&gt;</span><br><span class="line">&lt;/FrameLayout&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h2>
<ul>
<li>
<p>入门(<a target="_blank" rel="noopener" href="https://www.raywenderlich.com/169885/android-fragments-tutorial-introduction-2">https://www.raywenderlich.com/169885/android-fragments-tutorial-introduction-2</a>)</p>
</li>
<li>
<p>教程1</p>
<p>(<a target="_blank" rel="noopener" href="http://assets.en.oreilly.com/1/event/68/Fragments%20for%20All%20Presentation.pdf">http://assets.en.oreilly.com/1/event/68/Fragments for All Presentation.pdf</a>)</p>
</li>
<li>
<p>教程2</p>
<p>(<a target="_blank" rel="noopener" href="http://vinsol.com/blog/2014/09/15/advocating-fragment-oriented-applications-in-android/">http://vinsol.com/blog/2014/09/15/advocating-fragment-oriented-applications-in-android/</a>)</p>
</li>
<li>
<p>生命周期(<a target="_blank" rel="noopener" href="https://github.com/xxv/android-lifecycle">https://github.com/xxv/android-lifecycle</a>)</p>
</li>
<li>
<p>detach vs remove</p>
<p>(<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9156406/whats-the-difference-between-detaching-a-fragment-and-removing-it">https://stackoverflow.com/questions/9156406/whats-the-difference-between-detaching-a-fragment-and-removing-it</a>)</p>
</li>
<li>
<p>Google I/O 2016: What the Fragment?(<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=k3IT-IJ0J98">https://www.youtube.com/watch?v=k3IT-IJ0J98</a>)</p>
</li>
<li>
<p>Google I/O 2017: Fragment Tricks</p>
<p>(<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=eUG3VWnXFtg">https://www.youtube.com/watch?v=eUG3VWnXFtg</a>)</p>
</li>
<li>
<p>mAdded和mActive的区别(<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/25695960/difference-between-madded-mactive-in-source-code-of-support-fragmentmanager">https://stackoverflow.com/questions/25695960/difference-between-madded-mactive-in-source-code-of-support-fragmentmanager</a>)</p>
</li>
<li>
<p>如何避免IllegalStateException异常(<a target="_blank" rel="noopener" href="http://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html">http://www.androiddesignpatterns.com/2013/08/fragment-transaction-commit-state-loss.html</a>)</p>
</li>
</ul>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/Android-Fragment-cover.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/wechat.webp" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/wechat.webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/alipay.webp" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/alipay.webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/threeone"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/cover.webp" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">——三个？ ——一个。</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/QSCTech-Sange/picBed/Androidtop.webp)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 杨宇昊</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">我怎么就这么菜啊！</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: '4z8dfu0wvumOs1BjFBJ5jUQ3-gzGzoHsz# leancloud application app id',
      appKey: 'ikfFd8mKVK80FpjJve5nhHVF# leancloud application app key',
      placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
      avatar: 'monsterid',
      meta: 'nick,mail'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer="defer" id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>